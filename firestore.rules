rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function isPartnerOf(userId) {
      let profileDoc = get(/databases/$(database)/documents/users/$(userId)/profile/main);
      let profile = profileDoc.data;
      return isAuthenticated() &&
        profile != null &&
        (
        profile.partnerId == request.auth.uid ||
        (profile.partnerIds != null && request.auth.uid in profile.partnerIds)
      );
    }

    function callerHasLinkedTarget(targetUserId) {
      let callerDoc = get(/databases/$(database)/documents/users/$(request.auth.uid)/profile/main);
      let callerProfile = callerDoc.data;
      return callerProfile != null && (
        callerProfile.partnerId == targetUserId ||
        (callerProfile.partnerIds != null && targetUserId in callerProfile.partnerIds)
      );
    }

    // Profile: owner write/read, partners read.
    match /users/{userId}/profile/{document=**} {
      // Permitir lectura a usuarios autenticados para permitir vinculación
      allow read: if isAuthenticated();
      allow write: if isOwner(userId);
    }

    // Workout history
    match /users/{userId}/workoutHistory/{workoutId} {
      allow read: if isOwner(userId) || isPartnerOf(userId);
      allow write: if isOwner(userId);
      // Allow partner to create mirrored workout entries.
      allow create: if isPartnerOf(userId);
    }

    // Routine history
    match /users/{userId}/routineHistory/{routineId} {
      allow read: if isOwner(userId) || isPartnerOf(userId);
      allow write: if isOwner(userId);
    }

    // Extra activities
    match /users/{userId}/extraActivities/{activityId} {
      allow read: if isOwner(userId) || isPartnerOf(userId);
      allow write: if isOwner(userId);
    }

    // Alias lookup
    match /userAliases/{alias} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // User metadata
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow write: if isOwner(userId);
    }

    // FCM tokens
    match /users/{userId}/fcmTokens/{tokenId} {
      allow read, write: if isOwner(userId);
    }

    // Exercise catalog
    match /exercises/{exerciseId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.displayName == 'bypupila'
      );
    }

    // Link requests
    match /linkRequests/{requestId} {
      allow read: if isAuthenticated() && (
        resource.data.requesterId == request.auth.uid ||
        resource.data.recipientId == request.auth.uid
      );
      allow create: if isAuthenticated() &&
        request.resource.data.requesterId == request.auth.uid &&
        // Validar campos mínimos requeridos
        request.resource.data.requesterId is string &&
        request.resource.data.recipientId is string &&
        request.resource.data.requesterAlias is string &&
        request.resource.data.status == 'pending' &&
        // Evitar auto-vinculación
        request.resource.data.requesterId != request.resource.data.recipientId;
      allow update: if isAuthenticated() && (
        (
          // Recipient puede aceptar/rechazar y agregar su alias
          resource.data.recipientId == request.auth.uid &&
          request.resource.data.status in ['accepted', 'declined'] &&
          // Solo puede modificar status, resolvedAt y recipientAlias
          request.resource.data.requesterId == resource.data.requesterId &&
          request.resource.data.recipientId == resource.data.recipientId &&
          request.resource.data.requesterAlias == resource.data.requesterAlias
        ) ||
        (
          // Requester puede cancelar
          resource.data.requesterId == request.auth.uid &&
          request.resource.data.status == 'cancelled'
        ) ||
        (
          // Ambos pueden marcar como unlinked si estaba accepted
          (resource.data.requesterId == request.auth.uid || resource.data.recipientId == request.auth.uid) &&
          resource.data.status == 'accepted' &&
          request.resource.data.status == 'unlinked' &&
          // No puede cambiar otros campos
          request.resource.data.requesterId == resource.data.requesterId &&
          request.resource.data.recipientId == resource.data.recipientId &&
          request.resource.data.requesterAlias == resource.data.requesterAlias
        )
      );
      allow delete: if false;
    }

    // Relationship actions (unlink / break sync / manual sync)
    match /relationshipActions/{actionId} {
      allow read: if isAuthenticated() && (
        resource.data.sourceUserId == request.auth.uid ||
        resource.data.targetUserId == request.auth.uid
      );
      allow create: if isAuthenticated() &&
        request.resource.data.initiatedBy == request.auth.uid &&
        (
          // Acción normal (usuario como source)
          (request.resource.data.sourceUserId == request.auth.uid &&
           callerHasLinkedTarget(request.resource.data.targetUserId)) ||
          // Mirror action (usuario como target, para desvinculación bidireccional)
          (request.resource.data.targetUserId == request.auth.uid &&
           request.resource.data.mirrorOf is string)
        ) &&
        request.resource.data.actionType in ['UNLINK', 'BREAK_SYNC', 'SYNC_NOW'];
      allow update, delete: if false;
    }

    // Routine copy/sync requests
    match /routineRequests/{requestId} {
      allow read: if isAuthenticated() && (
        resource.data.fromUserId == request.auth.uid ||
        resource.data.toUserId == request.auth.uid
      );
      allow create: if isAuthenticated() &&
        request.resource.data.fromUserId == request.auth.uid &&
        request.resource.data.toUserId != request.auth.uid;
      allow update: if isAuthenticated() && (
        (
          resource.data.toUserId == request.auth.uid &&
          request.resource.data.status in ['accepted', 'declined']
        ) ||
        (
          resource.data.fromUserId == request.auth.uid &&
          request.resource.data.status == 'cancelled'
        )
      );
      allow delete: if false;
    }

    // Live sessions
    match /liveSessions/{sessionId} {
      allow read: if isAuthenticated() && (
        request.auth.uid in resource.data.participants
      );
      allow create: if isAuthenticated() &&
        request.resource.data.createdBy == request.auth.uid;
      allow update: if isAuthenticated() &&
        request.auth.uid in resource.data.participants;

      match /participants/{userId} {
        allow read: if isAuthenticated() && (
          request.auth.uid in get(/databases/$(database)/documents/liveSessions/$(sessionId)).data.participants
        );
        allow write: if isAuthenticated() &&
          request.auth.uid == userId &&
          request.auth.uid in get(/databases/$(database)/documents/liveSessions/$(sessionId)).data.participants;
      }
    }

    // Training invitations
    match /trainingInvitations/{invitationId} {
      allow read: if isAuthenticated() && (
        resource.data.fromUserId == request.auth.uid ||
        resource.data.toUserId == request.auth.uid
      );
      allow create: if isAuthenticated() &&
        request.resource.data.fromUserId == request.auth.uid;
      allow update: if isAuthenticated() &&
        resource.data.toUserId == request.auth.uid;
      allow delete: if isAuthenticated() && (
        resource.data.fromUserId == request.auth.uid ||
        resource.data.toUserId == request.auth.uid
      );
    }
  }
}
